<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロボットプログラミング体験教室 予約ポータル</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        /* カレンダーの日付セルの基本的なスタイル */
        .calendar-day {
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
        }
        /* 選択可能な日付のスタイル */
        .available {
            background-color: #c8f5e1;
            color: #0d774a;
            cursor: pointer;
            font-weight: 700;
        }
        .available:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        /* 選択中の日付のスタイル */
        .selected-day {
            background-color: #2dd4bf;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 0 3px #14b8a6;
        }
        /* 選択不可な日付のスタイル */
        .disabled {
            color: #cbd5e1;
        }
        /* アニメーション用のクラス */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .slide-in-up {
            animation: slideInUp 0.5s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* 初期状態の制御 */
        #bookingForm, #timeSlotsContainer, #calendarContainer {
            display: none;
        }
        
        /* ローディング */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ダッシュボードカレンダー用スタイル */
        .dashboard-calendar-cell {
            min-height: 100px;
            border: 1px solid #e2e8f0;
            padding: 4px;
            vertical-align: top;
        }
        .dashboard-event-item {
            font-size: 0.75rem;
            margin-bottom: 2px;
            padding: 2px 4px;
            border-radius: 3px;
            color: white; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .dashboard-event-item:hover {
            opacity: 0.9;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* タイムライン表示用 */
        .timeline-container {
            position: relative;
            height: 400px; /* 固定高さ */
            background-color: #fff;
            border-radius: 0.5rem;
            overflow-y: auto; /* スクロール */
            margin-bottom: 1rem;
            border: 1px solid #cbd5e1;
            cursor: crosshair; 
        }
        .timeline-hour-marker {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed #e2e8f0;
            height: 1px;
            font-size: 0.6rem;
            color: #94a3b8;
            pointer-events: none;
        }
        .timeline-hour-label {
             position: absolute;
             left: 2px;
             font-size: 0.65rem;
             color: #64748b;
             transform: translateY(-50%);
        }
        .timeline-event-block {
            position: absolute;
            left: 50px; 
            right: 10px;
            opacity: 0.95;
            border-radius: 4px;
            color: white;
            font-size: 0.7rem;
            padding: 4px 8px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: move; 
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.1s;
        }
        .timeline-event-block:hover {
            z-index: 20;
            transform: scale(1.02);
            opacity: 1;
        }
        .timeline-event-block.dragging {
            opacity: 0.7;
            z-index: 30;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 relative min-h-screen">

    <!-- ナビゲーションバー (共通) -->
    <nav id="globalNav" class="bg-slate-800 text-white p-3 shadow-md flex justify-between items-center z-50 relative hidden">
        <div class="flex items-center gap-4">
            <button id="navBackBtn" class="hover:bg-slate-700 p-2 rounded-full transition hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            </button>
            <h1 class="text-lg font-bold" id="navTitle">ロボットプログラミング教室予約</h1>
        </div>
        <div class="flex items-center gap-3">
            <span id="navUserName" class="text-xs text-slate-300"></span>
            <button id="toggleAdminBtn" class="bg-teal-600 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-teal-500 transition">
                管理者ログイン
            </button>
        </div>
    </nav>

    <!-- ロード画面 -->
    <div id="loadingScreen" class="fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="mt-4 text-slate-500 font-bold">Loading...</p>
    </div>

    <!-- コンテナ -->
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 mt-2 relative">

        <!-- === 1. 校舎選択画面 (ポータル) === -->
        <div id="schoolSelectionView" class="fade-in hidden">
            <div class="text-center mb-10 mt-8">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-800 mb-2">校舎を選んでください</h1>
                <p class="text-slate-500">お近くの教室で体験会に参加しよう！</p>
            </div>
            
            <div id="schoolListContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <!-- JSで校舎カードを生成 -->
            </div>

            <!-- 本部管理者用: 校舎追加ボタン (管理者のみ表示) -->
            <div id="hqControls" class="mt-12 border-t border-slate-200 pt-8 text-center hidden">
                <h3 class="text-lg font-bold text-slate-700 mb-4">本部管理メニュー</h3>
                <div class="flex justify-center gap-4">
                    <button id="addSchoolBtn" class="bg-slate-700 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-600 shadow transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                        新しい校舎を追加
                    </button>
                    <button id="manageMasterContentBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-500 shadow transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                        本部コンテンツ管理
                    </button>
                </div>
            </div>
        </div>

        <!-- === 2. ユーザー向け予約画面 (User View) === -->
        <div id="userView" class="max-w-2xl mx-auto hidden">
            <!-- ヘッダー情報 -->
            <header class="text-center mb-8">
                <div class="w-full h-48 sm:h-64 bg-slate-200 rounded-2xl mb-4 overflow-hidden shadow-lg relative group">
                    <img id="headerImage" src="" alt="教室イメージ" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center">
                         <p class="text-white font-bold text-xl drop-shadow-md"><span id="headerSchoolName"></span>校へようこそ</p>
                    </div>
                </div>
                <h1 id="pageTitleDisplay" class="text-3xl sm:text-4xl font-extrabold text-teal-600"></h1>
                <p id="pageDescriptionDisplay" class="mt-2 text-slate-600"></p>
                <div id="schoolInfoDisplay" class="mt-4 text-sm text-slate-500 bg-white p-3 rounded-lg inline-block shadow-sm"></div>
            </header>

            <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div id="mainContent">
                    <!-- ステップ1: 学年選択 -->
                    <div id="step1">
                        <h2 class="text-xl font-bold mb-4 text-center"><span class="bg-teal-500 text-white rounded-full px-3 py-1 mr-2">1</span>お子様の学年を選んでください</h2>
                        <div id="gradeSelector" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button data-grade="preschool" class="grade-btn w-full text-lg font-bold py-4 px-4 bg-white border-2 border-[#ff91aa] text-[#ff91aa] rounded-xl hover:bg-pink-50 transition-transform hover:scale-105">年中・年長</button>
                            <button data-grade="grade1_2" class="grade-btn w-full text-lg font-bold py-4 px-4 bg-white border-2 border-[#ffac2d] text-[#ffac2d] rounded-xl hover:bg-orange-50 transition-transform hover:scale-105">小1～小2</button>
                            <button data-grade="grade3_plus" class="grade-btn w-full text-lg font-bold py-4 px-4 bg-white border-2 border-[#00b4dc] text-[#00b4dc] rounded-xl hover:bg-blue-50 transition-transform hover:scale-105">小3以上</button>
                        </div>
                    </div>

                    <!-- カレンダー表示エリア -->
                    <div id="calendarContainer" class="mt-8">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prevMonth" class="px-3 py-1 bg-slate-200 rounded-md hover:bg-slate-300">&lt;</button>
                            <h3 id="calendarTitle" class="text-lg font-bold"></h3>
                            <button id="nextMonth" class="px-3 py-1 bg-slate-200 rounded-md hover:bg-slate-300">&gt;</button>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center">
                            <div class="font-bold text-red-500">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div class="font-bold text-blue-500">土</div>
                        </div>
                         <p class="text-xs text-center mt-2 text-slate-500"><span class="inline-block w-3 h-3 bg-slate-200 border border-slate-300 rounded-full mr-1"></span>が予約可能な日です</p>
                    </div>

                    <!-- 時間選択エリア -->
                    <div id="timeSlotsContainer" class="mt-6"></div>
                    
                    <!-- ステップ2 & 3: 情報入力と確認 -->
                    <div id="bookingForm" class="mt-8">
                         <div class="bg-teal-50 p-4 rounded-xl mb-6 border border-teal-200">
                            <img id="bookingContentImage" src="" alt="体験イメージ" class="w-full h-40 object-cover rounded-lg mb-4 hidden border border-slate-100">
                            <h3 class="font-bold text-teal-800">ご予約内容</h3>
                            <p class="mt-1 text-teal-700">
                                <span id="confirmSchoolName" class="font-bold"></span><br>
                                <span id="selectedSlotInfo"></span><br>
                                <span id="selectedPriceInfo" class="text-lg font-bold text-teal-600"></span>
                            </p>
                        </div>

                        <!-- 入力フェーズ -->
                        <div id="inputPhase">
                            <h2 class="text-xl font-bold mb-4 text-center"><span class="bg-teal-500 text-white rounded-full px-3 py-1 mr-2">2</span>保護者様の情報をご入力ください</h2>
                            <form id="userInfoForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">保護者様のお名前</label>
                                    <input type="text" id="parentName" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="山田 太郎">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">メールアドレス</label>
                                    <input type="email" id="email" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="example@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">電話番号</label>
                                    <input type="tel" id="phone" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="090-1234-5678">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">お子様のお名前 (かな)</label>
                                    <input type="text" id="childName" required class="w-full p-3 border border-slate-300 rounded-lg" placeholder="やまだ はなこ">
                                </div>
                                <div class="pt-4">
                                    <button type="submit" class="w-full text-lg font-extrabold py-4 px-6 bg-teal-500 text-white rounded-xl hover:bg-teal-600 shadow-lg">確認画面へ進む</button>
                                </div>
                            </form>
                        </div>

                        <!-- 確認フェーズ -->
                        <div id="confirmPhase" class="hidden">
                            <h2 class="text-xl font-bold mb-4 text-center"><span class="bg-teal-500 text-white rounded-full px-3 py-1 mr-2">3</span>入力内容の確認</h2>
                            <div class="bg-white border border-slate-200 p-6 rounded-xl shadow-inner mb-6 space-y-4">
                                <div class="border-b pb-2"><p class="text-xs text-slate-500">保護者様のお名前</p><p class="font-bold text-lg text-slate-800" id="confirmParentName"></p></div>
                                <div class="border-b pb-2"><p class="text-xs text-slate-500">メールアドレス</p><p class="font-bold text-lg text-slate-800" id="confirmEmail"></p></div>
                                <div class="border-b pb-2"><p class="text-xs text-slate-500">電話番号</p><p class="font-bold text-lg text-slate-800" id="confirmPhone"></p></div>
                                <div><p class="text-xs text-slate-500">お子様のお名前</p><p class="font-bold text-lg text-slate-800" id="confirmChildName"></p></div>
                            </div>
                            <div class="flex flex-col gap-3">
                                <button type="button" id="confirmBookingBtn" class="w-full text-lg font-extrabold py-4 px-6 bg-orange-500 text-white rounded-xl hover:bg-orange-600 shadow-lg">この内容で予約を確定する</button>
                                <button type="button" id="backToInputBtn" class="w-full text-sm font-bold py-3 px-6 bg-slate-200 text-slate-600 rounded-xl hover:bg-slate-300">修正する</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- === 3. 校舎管理画面 (Admin View) === -->
        <div id="adminView" class="hidden">
            <header class="mb-4 flex justify-between items-center border-b-4 border-slate-300 pb-2">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-700">校舎管理: <span id="adminSchoolNameDisplay"></span></h1>
                    <p class="mt-1 text-slate-600 text-sm">予約状況と設定の管理</p>
                </div>
            </header>

            <!-- タブナビゲーション -->
            <div class="flex border-b border-slate-200 mb-6 overflow-x-auto">
                <button class="tab-btn px-6 py-3 font-bold text-slate-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors active-tab" data-tab="dashboard">ダッシュボード</button>
                <button class="tab-btn px-6 py-3 font-bold text-slate-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors" data-tab="booking-management">予約管理</button>
                <button class="tab-btn px-6 py-3 font-bold text-slate-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors" data-tab="course-settings">体験会設定</button>
                <button class="tab-btn px-6 py-3 font-bold text-slate-500 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-500 transition-colors" data-tab="school-settings">教室設定</button>
            </div>

            <main class="bg-white p-4 sm:p-8 rounded-2xl shadow-lg border border-slate-200 min-h-[500px]">
                <!-- 1. ダッシュボード -->
                <div id="tab-dashboard" class="tab-content">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 border-l-4 border-blue-500 pl-3">予約状況ダッシュボード</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <h3 class="text-xs font-bold text-blue-800 uppercase">総予約数</h3>
                            <p class="text-2xl font-extrabold text-blue-600 mt-2" id="totalBookingsCount">0</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <h3 class="text-xs font-bold text-indigo-800 uppercase">今月の予約状況</h3>
                            <div class="flex items-baseline gap-1 mt-2">
                                <span class="text-2xl font-extrabold text-indigo-600" id="currentMonthBookings">0</span>
                                <span class="text-sm text-indigo-400">/</span>
                                <span class="text-lg font-bold text-indigo-400" id="currentMonthCapacity">0</span>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                            <h3 class="text-xs font-bold text-green-800 uppercase">直近の予約</h3>
                            <p class="text-xl font-bold text-green-600 mt-2" id="recentBookingDate">-</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mb-4 bg-slate-50 p-3 rounded-lg">
                        <button id="prevDashboardMonth" class="px-3 py-1 bg-white border border-slate-300 rounded font-bold text-slate-600">&lt; 前月</button>
                        <h3 id="dashboardCalendarTitle" class="text-lg font-bold text-slate-800"></h3>
                        <button id="nextDashboardMonth" class="px-3 py-1 bg-white border border-slate-300 rounded font-bold text-slate-600">翌月 &gt;</button>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="dashboardCalendar" class="min-w-[700px]">
                            <div class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-t-lg">
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-red-500">日</div>
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-slate-700">月</div>
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-slate-700">火</div>
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-slate-700">水</div>
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-slate-700">木</div>
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-slate-700">金</div>
                                <div class="bg-slate-100 text-center py-2 text-sm font-bold text-blue-500">土</div>
                            </div>
                            <div id="dashboardCalendarGrid" class="grid grid-cols-7 gap-px bg-slate-200 border-x border-b border-slate-200"></div>
                        </div>
                    </div>
                </div>

                <!-- 2. 予約管理 -->
                <div id="tab-booking-management" class="tab-content hidden">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 border-l-4 border-green-500 pl-3">予約申し込み一覧</h2>
                    <!-- フィルタエリア -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600 border border-slate-200">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100 border-b border-slate-200">
                                <tr>
                                    <th class="px-4 py-3">開催日</th>
                                    <th class="px-4 py-3">時間</th>
                                    <th class="px-4 py-3">コンテンツ名</th>
                                    <th class="px-4 py-3">申込者</th>
                                    <th class="px-4 py-3 text-center">種別</th>
                                </tr>
                            </thead>
                            <tbody id="bookingListTableBody" class="bg-white divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 3. 体験会設定 -->
                <div id="tab-course-settings" class="tab-content hidden">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 border-l-4 border-orange-500 pl-3">体験会コース設定</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-bold text-slate-700 mb-4">1. コンテンツ管理 (マスタ)</h3>
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                                <div class="space-y-3">
                                    <button type="button" id="openContentModalBtn" class="bg-orange-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-orange-600 transition w-full shadow-md flex items-center justify-center gap-2">
                                        <span class="text-2xl font-bold leading-none">+</span> 新規作成
                                    </button>
                                    <div class="text-center pt-2">
                                        <button type="button" id="openImportMasterModalBtn" class="text-indigo-600 text-xs font-bold hover:underline inline-flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                            本部マスタから取り込む
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="contentsListContainer" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-700 mb-4">2. 開催日程登録 (カレンダー)</h3>
                            <div class="flex items-center justify-between mb-2">
                                <button type="button" id="prevScheduleMonth" class="px-2 py-1 text-xs bg-white border rounded">&lt;</button>
                                <span id="scheduleCalendarTitle" class="font-bold text-slate-700"></span>
                                <button type="button" id="nextScheduleMonth" class="px-2 py-1 text-xs bg-white border rounded">&gt;</button>
                            </div>
                            <div id="scheduleCalendar" class="border border-slate-200 text-xs">
                                <div class="grid grid-cols-7 bg-slate-100 font-bold text-center py-1">
                                    <div class="text-red-500">日</div><div>...</div><div class="text-blue-500">土</div>
                                </div>
                                <div id="scheduleCalendarGrid" class="grid grid-cols-7 gap-px bg-slate-200 border-t border-slate-200"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. 教室設定 -->
                <form id="adminSettingsForm">
                    <div id="tab-school-settings" class="tab-content hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-6 border-l-4 border-purple-500 pl-3">教室基本情報</h2>
                        <div class="space-y-6 max-w-lg">
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">教室名</label>
                                <input type="text" name="schoolName" id="adminSchoolNameInput" class="w-full p-3 border rounded" placeholder="例: 渋谷">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">教室ID (URL等に使用)</label>
                                <input type="text" name="schoolId" id="adminSchoolIdInput" class="w-full p-3 border rounded bg-slate-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">住所</label>
                                <input type="text" name="address" id="adminAddressInput" class="w-full p-3 border rounded" placeholder="例: 東京都渋谷区...">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">電話番号</label>
                                <input type="text" name="phoneNumber" id="adminPhoneInput" class="w-full p-3 border rounded" placeholder="例: 03-1234-5678">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">予約ページタイトル</label>
                                <input type="text" name="pageTitle" id="adminPageTitleInput" class="w-full p-3 border rounded" placeholder="例: ロボットプログラミング体験教室">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">予約ページ説明文</label>
                                <input type="text" name="pageDescription" id="adminPageDescriptionInput" class="w-full p-3 border rounded" placeholder="例: 未来を創る！">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-1">ヘッダー画像URL</label>
                                <input type="text" name="headerImageUrl" id="adminHeaderImageInput" class="w-full p-3 border rounded" placeholder="https://...">
                            </div>
                        </div>
                    </div>
                    <div id="saveBtnContainer" class="sticky bottom-0 bg-white/90 backdrop-blur pt-4 pb-2 border-t mt-6 flex justify-between items-center hidden">
                        <span class="text-sm text-slate-500">※変更は保存ボタンを押してください</span>
                        <button type="submit" id="saveSettingsBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg">設定を保存</button>
                    </div>
                </form>
            </main>
        </div>

    </div>

    <!-- === MODALS === -->
    
    <!-- 校舎追加モーダル -->
    <div id="addSchoolModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold mb-4">新しい校舎を追加</h3>
            <form id="addSchoolForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">校舎名</label>
                    <input type="text" id="newSchoolName" required class="w-full p-2 border rounded" placeholder="例: 新宿">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">校舎ID (半角英数)</label>
                    <input type="text" id="newSchoolId" required class="w-full p-2 border rounded" placeholder="例: shinjuku">
                </div>
                <button type="submit" class="w-full bg-slate-700 text-white font-bold py-2 rounded">追加</button>
                <button type="button" id="closeAddSchoolModal" class="w-full text-slate-500 text-sm mt-2">キャンセル</button>
            </form>
        </div>
    </div>

    <!-- 本部コンテンツ管理モーダル (HQ Content Modal) -->
    <div id="hqContentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                <h3 class="text-lg font-bold text-indigo-700">本部コンテンツマスタ管理</h3>
                <button onclick="document.getElementById('hqContentModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto mb-4">
                <div id="hqContentList" class="space-y-2"></div>
            </div>
            
            <div class="bg-slate-50 p-4 rounded border-t">
                <h4 class="text-sm font-bold mb-2">新規マスタコンテンツ登録</h4>
                <div class="space-y-2 text-sm">
                    <input type="text" id="hqNewName" class="w-full p-2 border rounded" placeholder="コンテンツ名">
                    <div class="flex gap-2">
                        <select id="hqNewType" class="w-full p-2 border rounded"><option value="trial">体験会</option><option value="event">イベント</option></select>
                        <input type="number" id="hqNewPrice" class="w-full p-2 border rounded" placeholder="金額">
                    </div>
                    <div class="flex gap-2">
                        <label><input type="checkbox" class="hq-grade-chk" value="preschool"> 年中長</label>
                        <label><input type="checkbox" class="hq-grade-chk" value="grade1_2"> 小1-2</label>
                        <label><input type="checkbox" class="hq-grade-chk" value="grade3_plus"> 小3+</label>
                    </div>
                    <button id="hqAddBtn" class="w-full bg-indigo-600 text-white font-bold py-2 rounded mt-2">マスタに追加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- マスタから取込モーダル (Import Modal) -->
    <div id="importMasterModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl max-h-[80vh] flex flex-col">
            <h3 class="text-lg font-bold mb-4">本部マスタからコンテンツを追加</h3>
            <p class="text-xs text-slate-500 mb-2">選択したコンテンツをこの校舎のリストにコピーします。</p>
            <div id="importListContainer" class="flex-1 overflow-y-auto space-y-2 mb-4 p-2 bg-slate-50 rounded"></div>
            <button onclick="document.getElementById('importMasterModal').classList.add('hidden')" class="w-full py-2 bg-slate-200 rounded text-sm font-bold">閉じる</button>
        </div>
    </div>

    <!-- コンテンツ登録モーダル (独自作成) -->
    <div id="contentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold mb-4 flex justify-between items-center">
                <span id="contentFormTitle">新規作成</span>
                <button id="closeContentModal" class="text-slate-400 hover:text-slate-600">×</button>
            </h3>
            
            <div class="space-y-4">
                <input type="hidden" id="editingContentId" value="">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">コンテンツ名</label>
                    <input type="text" id="newContentName" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="例: はじめてのロボット">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">バナー画像URL</label>
                    <input type="text" id="newContentImage" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="https://example.com/image.jpg">
                    <p class="text-[10px] text-slate-400 mt-1">※画像のURLを入力してください（任意）</p>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 mb-1">種別</label>
                        <select id="newContentType" class="w-full p-2 border border-slate-300 rounded text-sm">
                            <option value="trial">体験会</option>
                            <option value="event">イベント</option>
                        </select>
                    </div>
                    <!-- 時間(分)の入力欄は削除されました -->
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 mb-1">金額(円)</label>
                        <input type="number" id="newContentPrice" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="1500">
                    </div>
                </div>
                
                <button type="button" id="addContentBtn" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition shadow-md">作成して保存</button>
            </div>
        </div>
    </div>

    <!-- スケジュール登録モーダル -->
    <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl transform transition-all scale-100 max-h-[85vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 flex justify-between items-center border-b border-slate-100 pb-2">
                <span id="modalDateDisplay">2025-12-24</span> の設定
                <button id="closeScheduleModal" class="text-slate-400 hover:text-slate-600">×</button>
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 左側：タイムライン -->
                <div>
                    <h4 class="text-xs font-bold text-slate-500 mb-2">タイムライン</h4>
                    <div class="timeline-container relative bg-slate-50 border border-slate-200 rounded h-[300px] overflow-y-auto">
                        <!-- 時間軸メモリ -->
                        <div id="timelineAxis" class="absolute left-0 top-0 bottom-0 w-8 border-r border-slate-200 bg-white text-[10px] text-slate-400 text-center pt-1">
                            <!-- JSで生成 -->
                        </div>
                        <div id="scheduleTimeline" class="absolute left-8 right-0 top-0 bottom-0 relative h-[660px]">
                            <!-- JSでバーを追加 -->
                        </div>
                    </div>
                </div>

                <!-- 右側：登録・編集フォーム -->
                <div>
                    <h4 class="text-xs font-bold text-slate-500 mb-2 flex justify-between items-center">
                        <span id="scheduleFormTitle">新規枠を追加</span>
                        <button type="button" id="cancelScheduleEditBtn" class="text-xs text-blue-500 hover:underline hidden">キャンセル</button>
                    </h4>
                    <div class="space-y-3 bg-white">
                        <input type="hidden" id="editingScheduleIndex" value="-1">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">コンテンツ</label>
                            <select id="modalContentSelect" class="w-full p-2 border border-slate-300 rounded text-sm bg-white"></select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">対象学年</label>
                            <p class="text-[10px] text-red-500 mb-1 hidden" id="scheduleGradeErrorMsg">※少なくとも1つ選択してください</p>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <label class="inline-flex items-center"><input type="checkbox" class="schedule-grade-check mr-1" value="preschool"> 年中・年長</label>
                                <label class="inline-flex items-center"><input type="checkbox" class="schedule-grade-check mr-1" value="grade1_2"> 小1～小2</label>
                                <label class="inline-flex items-center"><input type="checkbox" class="schedule-grade-check mr-1" value="grade3_plus"> 小3以上</label>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="block text-xs text-slate-500 mb-1">開始</label>
                                <input type="time" id="modalStartTime" class="w-full p-2 border border-slate-300 rounded text-sm">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-slate-500 mb-1">終了</label>
                                <input type="time" id="modalEndTime" class="w-full p-2 border border-slate-300 rounded text-sm">
                            </div>
                        </div>
                        <div class="w-20">
                             <label class="block text-xs text-slate-500 mb-1">定員</label>
                             <input type="number" id="modalCapacity" value="5" class="w-full p-2 border border-slate-300 rounded text-sm">
                        </div>
                        
                        <div class="flex gap-2 mt-4 pt-2 border-t border-slate-100">
                             <button type="button" id="deleteScheduleBtn" class="flex-1 bg-red-100 text-red-600 font-bold py-2 rounded hover:bg-red-200 text-sm hidden">削除</button>
                             <button type="button" id="addScheduleBtn" class="flex-[2] bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 text-sm">追加して保存</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 既存スケジュールリスト（複製ボタン付き） -->
            <div class="mt-6 pt-4 border-t border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 mb-2">登録済みリスト (複製操作)</h4>
                <div id="dayScheduleList" class="space-y-2 text-sm max-h-32 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <!-- 複製先日付選択ダイアログ -->
    <div id="copyDialog" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white rounded-lg p-4 shadow-xl max-w-xs w-full">
            <h4 class="font-bold text-slate-700 mb-2">スケジュールの複製</h4>
            <p class="text-xs text-slate-500 mb-3">このスケジュールをコピーする日付を選択してください。</p>
            <input type="date" id="copyTargetDate" class="w-full p-2 border border-slate-300 rounded mb-4">
            <div class="flex justify-end gap-2">
                <button id="cancelCopyBtn" class="px-3 py-1 bg-slate-200 text-slate-600 rounded text-sm">キャンセル</button>
                <button id="execCopyBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-bold">複製する</button>
            </div>
        </div>
    </div>

    <!-- 予約詳細モーダル -->
    <div id="bookingDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl p-6 max-w-lg w-full shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-start mb-4 border-b border-slate-100 pb-2">
                <div>
                    <h3 class="text-lg font-bold text-slate-800" id="detailModalTitle">体験会詳細</h3>
                    <p class="text-sm text-slate-500" id="detailModalSubtitle"></p>
                </div>
                <button id="closeDetailModal" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">×</button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-4 py-2">お名前</th>
                            <th class="px-4 py-2">保護者様</th>
                            <th class="px-4 py-2">連絡先</th>
                            <th class="px-4 py-2 text-right">申込日時</th>
                        </tr>
                    </thead>
                    <tbody id="bookingDetailList"></tbody>
                </table>
                <div id="noBookingsMsg" class="text-center py-8 text-slate-400 hidden">予約はありません</div>
            </div>
            
            <div class="mt-4 pt-2 border-t border-slate-100 text-right">
                <button class="px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 font-bold text-sm" onclick="document.getElementById('bookingDetailModal').classList.add('hidden')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 完了モーダル -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full text-center">
            <h2 class="text-2xl font-bold mb-2 text-green-600">予約完了！</h2>
            <div id="modal-summary" class="text-left bg-slate-50 p-4 rounded mb-4 text-sm"></div>
            <button id="closeModal" class="w-full py-3 bg-teal-500 text-white font-bold rounded">閉じる</button>
        </div>
    </div>

    <!-- ログインモーダル -->
    <div id="loginModal" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full relative">
            <button id="closeLoginModal" class="absolute top-4 right-4 text-slate-400">&times;</button>
            <h2 class="text-xl font-bold text-center mb-6">管理者ログイン</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="adminEmail" class="w-full p-3 border rounded" placeholder="admin@example.com">
                <input type="password" id="adminPassword" class="w-full p-3 border rounded" placeholder="••••••••">
                <button type="submit" id="loginSubmitBtn" class="w-full py-3 bg-slate-800 text-white font-bold rounded">ログイン</button>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 pointer-events-none transition-opacity duration-300 z-[70]"></div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, collection, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Grade Configuration
    const GRADE_CONFIG = {
        preschool: { label: '年中・年長', bg: 'bg-[#ff91aa]', text: 'text-white', btnBorder: 'border-[#ff91aa]', btnText: 'text-[#ff91aa]', btnHover: 'hover:bg-pink-50' },
        grade1_2: { label: '小1～小2', bg: 'bg-[#ffac2d]', text: 'text-white', btnBorder: 'border-[#ffac2d]', btnText: 'text-[#ffac2d]', btnHover: 'hover:bg-orange-50' },
        grade3_plus: { label: '小3以上', bg: 'bg-[#00b4dc]', text: 'text-white', btnBorder: 'border-[#00b4dc]', btnText: 'text-[#00b4dc]', btnHover: 'hover:bg-blue-50' }
    };

    const DEFAULT_CONTENTS = [
        { id: "c1", name: "はじめてのロボット体験", type: "trial", price: 1500, grades: ["preschool"], imageUrl: "https://images.unsplash.com/photo-1581092921461-eab62e97a782?q=80&w=2070" }, 
        { id: "c2", name: "探検ロボットプログラミング", type: "trial", price: 2200, grades: ["grade1_2"], imageUrl: "https://images.unsplash.com/photo-1535378437327-b7149a516c58?q=80&w=2070" },
        { id: "c3", name: "AIロボット開発チャレンジ", type: "event", price: 3300, grades: ["grade3_plus"], imageUrl: "https://images.unsplash.com/photo-1485827404703-89b55fcc595e?q=80&w=2070" }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        let auth, db, user;
        let appId = 'robot-school-booking-v4';
        
        // State
        let schools = []; 
        let currentSchoolId = null; 
        let currentSettings = null; 
        let allBookings = []; 
        let isAdmin = false; 
        let masterContents = []; // HQ Master Contents List
        
        // UI State
        let adminDashboardDate = new Date();
        let adminScheduleDate = new Date();
        let selectedScheduleDateStr = "";
        let editingContentId = null;
        let editingScheduleIndex = -1;
        let selectedGrade = null;
        let selectedDate = null;
        let selectedContent = null;
        let selectedStartTime = "";
        let selectedSlotCapacity = 0;
        let pendingBookingData = null;
        let scheduleToCopy = null; // 複製用
        let draggingItemIndex = null;
        let dragStartY = 0;

        // Elements
        const views = {
            loading: document.getElementById('loadingScreen'),
            schoolSelect: document.getElementById('schoolSelectionView'),
            user: document.getElementById('userView'),
            admin: document.getElementById('adminView')
        };
        const nav = {
            bar: document.getElementById('globalNav'),
            backBtn: document.getElementById('navBackBtn'),
            title: document.getElementById('navTitle'),
            user: document.getElementById('navUserName'),
            adminBtn: document.getElementById('toggleAdminBtn')
        };

        // --- Init ---
        const initFirebase = async () => {
            const config = { apiKey: "AIzaSyBYjDRWH0ldsP8WVHa9o8HcfGJ2XF9pdzU", authDomain: "robot-school-booking.firebaseapp.com", projectId: "robot-school-booking", appId: "1:443474003538:web:e3a17bd422bcee23f6418b" };
            const app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
            
            onAuthStateChanged(auth, async (u) => {
                user = u;
                updateAuthUI();
                if (u) {
                    await loadSchoolList();
                    loadMasterContents(); // Load HQ contents
                    views.loading.classList.add('hidden');
                    switchView('schoolSelect');
                }
            });
        };

        const saveSettingsToFirestore = async (newSettings) => {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', currentSchoolId), newSettings);
                showToast('保存しました');
            } catch (err) {
                console.error(err);
                alert('保存に失敗しました');
            }
        };

        // --- Data Loading ---
        
        const loadSchoolList = async () => {
            const schoolsRef = collection(db, 'artifacts', appId, 'public', 'data', 'schools');
            onSnapshot(schoolsRef, (snap) => {
                schools = [];
                snap.forEach(doc => schools.push({ id: doc.id, ...doc.data() }));
                if (schools.length === 0 && !isAdmin) { 
                    createDefaultSchool('shibuya', '渋谷');
                }
                renderSchoolList();
            });
        };

        // Load HQ Master Contents
        const loadMasterContents = () => {
            const masterRef = collection(db, 'artifacts', appId, 'public', 'data', 'master_contents');
            onSnapshot(masterRef, (snap) => {
                masterContents = [];
                snap.forEach(doc => masterContents.push({ id: doc.id, ...doc.data() }));
                // Initialize master with defaults if empty (once)
                if (masterContents.length === 0 && isAdmin) {
                    DEFAULT_CONTENTS.forEach(c => addDoc(masterRef, c));
                }
                renderHqContentList();
            });
        };

        const createDefaultSchool = async (id, name) => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schools', id), { name, id });
            const defaultSettings = {
                schoolName: name, schoolId: id,
                address: "東京都渋谷区...", phoneNumber: "03-1234-5678",
                pageTitle: "ロボット教室", pageDescription: "未来を創る！",
                headerImageUrl: "https://images.unsplash.com/photo-1581092921461-eab62e97a782?q=80&w=2070",
                contents: JSON.parse(JSON.stringify(DEFAULT_CONTENTS)), // Deep copy defaults
                schedule: {}
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', id), defaultSettings);
        };

        const deleteSchool = async (schoolId) => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schools', schoolId));
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', schoolId));
                showToast('校舎を削除しました');
            } catch (err) {
                console.error("削除エラー:", err);
                alert("削除に失敗しました");
            }
        };

        const loadSchoolData = (schoolId) => {
            currentSchoolId = schoolId;
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', schoolId);
            onSnapshot(settingsRef, (snap) => {
                if (snap.exists()) {
                    currentSettings = snap.data();
                    if(!currentSettings.contents) currentSettings.contents = [];
                    if(!currentSettings.schedule) currentSettings.schedule = {};
                } else {
                    createDefaultSchool(schoolId, schools.find(s=>s.id===schoolId)?.name || schoolId);
                }
                if (isAdmin && !document.getElementById('adminView').classList.contains('hidden')) {
                    renderAdminView();
                } else {
                    renderUserView();
                }
            });

            const bookingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
            onSnapshot(bookingsRef, (snap) => {
                allBookings = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.schoolId === schoolId) {
                        allBookings.push({ id: doc.id, ...data });
                    }
                });
                if (isAdmin) {
                    renderAdminDashboard();
                    renderBookingManagement();
                }
                if (selectedDate && document.getElementById('timeSlotsContainer').style.display !== 'none') {
                    renderTimeSlots(selectedDate);
                }
            });
        };

        const switchView = (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            nav.bar.classList.remove('hidden');
            if (viewName === 'schoolSelect') {
                nav.backBtn.classList.add('hidden');
                nav.title.textContent = 'ロボットプログラミング教室予約';
                currentSchoolId = null;
                if (isAdmin) document.getElementById('hqControls').classList.remove('hidden');
                else document.getElementById('hqControls').classList.add('hidden');
            } else {
                nav.backBtn.classList.remove('hidden');
            }
        };

        nav.backBtn.addEventListener('click', () => {
            resetBookingView();
            switchView('schoolSelect');
        });

        // --- School List ---
        const renderSchoolList = () => {
            const container = document.getElementById('schoolListContainer');
            container.innerHTML = '';
            schools.forEach(school => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl shadow-lg hover:shadow-xl transition cursor-pointer border border-slate-100 flex flex-col items-center justify-center gap-4 group relative";
                let deleteBtnHtml = '';
                if (isAdmin) {
                    deleteBtnHtml = `<button class="absolute top-2 right-2 text-slate-300 hover:text-red-500 p-2 transition delete-school-btn" data-id="${school.id}" title="校舎を削除"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                }
                card.innerHTML = `${deleteBtnHtml}<div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 group-hover:bg-teal-500 group-hover:text-white transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></div><h3 class="text-xl font-bold text-slate-700">${school.name}校</h3><p class="text-xs text-slate-400">ID: ${school.id}</p><button class="mt-2 text-teal-600 font-bold underline decoration-2 underline-offset-4 group-hover:text-teal-700">${isAdmin ? '管理画面へ' : '予約する'}</button>`;
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-school-btn')) return;
                    loadSchoolData(school.id);
                    switchView(isAdmin ? 'admin' : 'user');
                });
                if (isAdmin) {
                    const delBtn = card.querySelector('.delete-school-btn');
                    delBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm(`本当に「${school.name}校」を削除しますか？\n※この操作は取り消せません。`)) {
                            await deleteSchool(school.id);
                        }
                    });
                }
                container.appendChild(card);
            });
        };

        const updateAuthUI = () => {
            isAdmin = user && !user.isAnonymous;
            nav.user.textContent = isAdmin ? (user.email || 'Admin') : '';
            nav.adminBtn.textContent = isAdmin ? 'ログアウト' : '管理者ログイン';
            nav.adminBtn.classList.toggle('bg-red-500', isAdmin);
            nav.adminBtn.classList.toggle('bg-teal-600', !isAdmin);
            if (isAdmin) {
                document.getElementById('hqControls').classList.remove('hidden');
            } else {
                document.getElementById('hqControls').classList.add('hidden');
                if(views.admin.classList.contains('hidden') === false) switchView('schoolSelect');
            }
        };

        nav.adminBtn.addEventListener('click', async () => {
            if (isAdmin) {
                await signOut(auth);
                await signInAnonymously(auth);
                showToast('ログアウトしました');
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        });

        // HQ Management
        document.getElementById('addSchoolBtn').addEventListener('click', () => document.getElementById('addSchoolModal').classList.remove('hidden'));
        document.getElementById('closeAddSchoolModal').addEventListener('click', () => document.getElementById('addSchoolModal').classList.add('hidden'));
        document.getElementById('addSchoolForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newSchoolName').value;
            const id = document.getElementById('newSchoolId').value;
            if(schools.some(s => s.id === id)) { alert('このIDは既に使用されています'); return; }
            await createDefaultSchool(id, name);
            document.getElementById('addSchoolModal').classList.add('hidden');
            e.target.reset();
            showToast(`${name}校を追加しました`);
        });

        document.getElementById('manageMasterContentBtn').addEventListener('click', () => {
            document.getElementById('hqContentModal').classList.remove('hidden');
            renderHqContentList();
        });

        // HQ Content List Logic
        const renderHqContentList = () => {
            const list = document.getElementById('hqContentList');
            list.innerHTML = '';
            masterContents.forEach(c => {
                const d = document.createElement('div');
                d.className = "flex justify-between items-center bg-slate-50 p-2 rounded border";
                d.innerHTML = `<span class="font-bold">${c.name}</span> <span class="text-xs text-slate-500">${c.type} / ¥${c.price}</span>`;
                const delBtn = document.createElement('button');
                delBtn.className = "text-red-500 text-xs ml-2";
                delBtn.textContent = "削除";
                delBtn.onclick = async () => {
                    if(confirm("削除しますか？")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master_contents', c.id));
                };
                d.appendChild(delBtn);
                list.appendChild(d);
            });
        };

        document.getElementById('hqAddBtn').addEventListener('click', async () => {
            const name = document.getElementById('hqNewName').value;
            const price = document.getElementById('hqNewPrice').value;
            const type = document.getElementById('hqNewType').value;
            const grades = Array.from(document.querySelectorAll('.hq-grade-chk:checked')).map(c=>c.value);
            
            if(!name || !price) return alert("入力してください");
            
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'master_contents'), {
                name, price: parseInt(price), type, grades,
                imageUrl: "https://images.unsplash.com/photo-1581092921461-eab62e97a782?q=80&w=2070"
            });
            
            document.getElementById('hqNewName').value = '';
            document.getElementById('hqNewPrice').value = '';
            renderHqContentList();
        });

        // Login Logic
        document.getElementById('closeLoginModal').onclick = () => document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loginModal').classList.add('hidden');
                showToast('ログインしました');
            } catch (e) {
                alert('ログイン失敗: ' + e.message);
            }
        };

        // --- Content Management (Local) ---
        
        // 1. Add Custom Content
        document.getElementById('openContentModalBtn').addEventListener('click', () => {
            editingContentId = null; // New
            document.getElementById('newContentName').value = '';
            document.getElementById('newContentPrice').value = '';
            document.getElementById('newContentImage').value = '';
            document.querySelectorAll('.custom-grade-chk').forEach(c=>c.checked=false);
            document.getElementById('contentModal').classList.remove('hidden');
        });
        
        document.getElementById('closeContentModal').addEventListener('click', () => {
            document.getElementById('contentModal').classList.add('hidden');
        });

        // 2. Import from Master
        document.getElementById('openImportMasterModalBtn').addEventListener('click', () => {
            const container = document.getElementById('importListContainer');
            container.innerHTML = '';
            if(masterContents.length === 0) container.innerHTML = '<p class="text-slate-400 text-center">本部マスタがありません</p>';
            
            masterContents.forEach(c => {
                const d = document.createElement('div');
                d.className = "p-2 border rounded bg-white hover:bg-indigo-50 cursor-pointer flex justify-between items-center";
                d.innerHTML = `<div><div class="font-bold text-sm">${c.name}</div><div class="text-xs text-slate-500">¥${c.price}</div></div><button class="text-xs bg-indigo-500 text-white px-2 py-1 rounded">追加</button>`;
                d.onclick = async () => {
                    const newContent = { ...c, id: 'c'+Date.now() }; // New ID for local
                    const newContents = [...(currentSettings.contents || []), newContent];
                    await saveSettingsToFirestore({ ...currentSettings, contents: newContents });
                    document.getElementById('importMasterModal').classList.add('hidden');
                };
                container.appendChild(d);
            });
            document.getElementById('importMasterModal').classList.remove('hidden');
        });

        // Save Custom Content
        document.getElementById('addContentBtn').addEventListener('click', async () => {
            const name = document.getElementById('newContentName').value;
            const price = document.getElementById('newContentPrice').value;
            const type = document.getElementById('newContentType').value;
            const img = document.getElementById('newContentImage').value;
            const grades = Array.from(document.querySelectorAll('.custom-grade-chk:checked')).map(c=>c.value);
            
            if(!name || !price) return alert("必須項目を入力してください");
            
            const newContent = {
                id: editingContentId || ('c'+Date.now()),
                name, type, price: parseInt(price), imageUrl: img, grades
            };
            
            let newContents = [...(currentSettings.contents || [])];
            if(editingContentId) {
                const idx = newContents.findIndex(c => c.id === editingContentId);
                if(idx !== -1) newContents[idx] = newContent;
            } else {
                newContents.push(newContent);
            }
            
            await saveSettingsToFirestore({ ...currentSettings, contents: newContents });
            document.getElementById('contentModal').classList.add('hidden');
        });

        // --- Render Functions (Admin) ---
        function renderAdminView() {
            document.getElementById('adminSchoolNameDisplay').textContent = currentSettings.schoolName;
            document.getElementById('adminSchoolNameInput').value = currentSettings.schoolName;
            document.getElementById('adminSchoolIdInput').value = currentSettings.schoolId;
            document.getElementById('adminAddressInput').value = currentSettings.address || "";
            document.getElementById('adminPhoneInput').value = currentSettings.phoneNumber || "";
            document.getElementById('adminPageTitleInput').value = currentSettings.pageTitle;
            document.getElementById('adminPageDescriptionInput').value = currentSettings.pageDescription;
            document.getElementById('adminHeaderImageInput').value = currentSettings.headerImageUrl;
            
            renderContentsList();
            renderScheduleCalendar();
            renderAdminDashboard();
            renderBookingManagement();
        }

        function renderContentsList() {
            const container = document.getElementById('contentsListContainer');
            container.innerHTML = '';
            (currentSettings.contents || []).forEach((c, i) => {
                const d = document.createElement('div');
                d.className = "bg-white p-3 rounded border flex justify-between items-center text-sm";
                d.innerHTML = `<div><div class="font-bold">${c.name}</div><div class="text-xs text-slate-500">${c.type} ¥${c.price}</div></div><div><button class="text-blue-500 mr-2 edit-cnt" data-idx="${i}">編集</button><button class="text-red-500 del-cnt" data-idx="${i}">削除</button></div>`;
                container.appendChild(d);
            });
            
            container.querySelectorAll('.edit-cnt').forEach(b => b.onclick = (e) => {
                const c = currentSettings.contents[e.target.dataset.idx];
                editingContentId = c.id;
                document.getElementById('newContentName').value = c.name;
                document.getElementById('newContentPrice').value = c.price;
                document.getElementById('newContentType').value = c.type;
                document.getElementById('newContentImage').value = c.imageUrl || '';
                document.querySelectorAll('.custom-grade-chk').forEach(chk => chk.checked = (c.grades || []).includes(chk.value));
                document.getElementById('contentModal').classList.remove('hidden');
            });
            
            // 修正箇所：削除ボタンのイベントハンドラ
            container.querySelectorAll('.del-cnt').forEach(b => b.onclick = async (e) => {
                const idx = parseInt(e.target.dataset.idx);
                if(confirm('削除しますか？')) {
                    const newContents = [...currentSettings.contents];
                    newContents.splice(idx, 1);
                    await saveSettingsToFirestore({ ...currentSettings, contents: newContents });
                }
            });
        }

        // 復元箇所：カレンダー描画ロジック
        function renderScheduleCalendar() {
            const year = adminScheduleDate.getFullYear();
            const month = adminScheduleDate.getMonth();
            document.getElementById('scheduleCalendarTitle').textContent = `${year}年 ${month + 1}月`;
            
            const grid = document.getElementById('scheduleCalendarGrid');
            grid.innerHTML = '';
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                const div = document.createElement('div');
                div.className = "bg-slate-50 border border-slate-200 min-h-[80px]";
                grid.appendChild(div);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = "bg-white p-1 min-h-[80px] border-b border-r border-slate-100 hover:bg-yellow-50 cursor-pointer";
                cell.innerHTML = `<div class="font-bold text-slate-400 mb-1 text-xs">${day}</div>`;
                
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                
                if (currentSettings.schedule && currentSettings.schedule[dateStr]) {
                    currentSettings.schedule[dateStr].forEach(item => {
                        const content = (currentSettings.contents || []).find(c => c.id === item.contentId) || { name: '不明' };
                        const div = document.createElement('div');
                        
                        let colorClass = "bg-blue-100 text-blue-800";
                        if (item.grades && item.grades.length > 0) {
                             if(item.grades.includes('preschool')) colorClass = "bg-[#ff91aa] text-white";
                             else if(item.grades.includes('grade1_2')) colorClass = "bg-[#ffac2d] text-white";
                             else if(item.grades.includes('grade3_plus')) colorClass = "bg-[#00b4dc] text-white";
                        }

                        div.className = `${colorClass} rounded px-1 mb-1 text-[10px] truncate`;
                        div.textContent = `${item.startTime} ${content.name}`;
                        cell.appendChild(div);
                    });
                }

                cell.addEventListener('click', () => openScheduleModal(dateStr));
                grid.appendChild(cell);
            }
        }

        // 復元箇所：ダッシュボードロジック
        function renderAdminDashboard() {
            document.getElementById('totalBookingsCount').textContent = allBookings.length;
            
            // 直近の予約
            if (allBookings.length > 0) {
                 const sorted = [...allBookings].sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);
                 const lastDate = sorted[0].createdAt ? new Date(sorted[0].createdAt.seconds * 1000) : new Date();
                 document.getElementById('recentBookingDate').textContent = `${lastDate.getMonth()+1}/${lastDate.getDate()} ${lastDate.getHours()}:${String(lastDate.getMinutes()).padStart(2,'0')}`;
            } else {
                 document.getElementById('recentBookingDate').textContent = "なし";
            }

            // 今月の予約状況
            const today = new Date();
            const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            let totalCapacity = 0;
            // 枠数集計 (簡易版: 文字列マッチ)
            const monthPrefix = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
            Object.keys(currentSettings.schedule || {}).forEach(dateStr => {
                if (dateStr.startsWith(monthPrefix)) {
                    currentSettings.schedule[dateStr].forEach(s => totalCapacity += parseInt(s.capacity));
                }
            });

            // 予約数集計
            let bookingCount = 0;
            allBookings.forEach(b => {
                if(b.date && b.date.startsWith(monthPrefix)) {
                    bookingCount++;
                }
            });

            document.getElementById('currentMonthBookings').textContent = bookingCount;
            document.getElementById('currentMonthCapacity').textContent = totalCapacity;

            // Dashboard Calendar
            const year = adminDashboardDate.getFullYear();
            const month = adminDashboardDate.getMonth();
            document.getElementById('dashboardCalendarTitle').textContent = `${year}年 ${month + 1}月`;
            
            const grid = document.getElementById('dashboardCalendarGrid');
            grid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                const empty = document.createElement('div');
                empty.className = "bg-slate-50 border border-slate-200 min-h-[100px]";
                grid.appendChild(empty);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = "bg-white dashboard-calendar-cell";
                cell.innerHTML = `<div class="text-xs font-bold text-slate-500 mb-1">${day}</div>`;
                
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                
                if (currentSettings.schedule && currentSettings.schedule[dateStr]) {
                    const dayEvents = currentSettings.schedule[dateStr];
                    dayEvents.sort((a,b) => a.startTime.localeCompare(b.startTime));

                    dayEvents.forEach(evt => {
                        const content = (currentSettings.contents || []).find(c => c.id === evt.contentId) || { name: '??' };
                        const count = allBookings.filter(b => b.date === dateStr && b.startTime === evt.startTime && b.contentId === evt.contentId).length;
                        const remaining = evt.capacity - count;
                        
                        const item = document.createElement('div');
                        let colorClass = "bg-gray-400"; 
                        if (evt.grades && evt.grades.length > 0) {
                            if (evt.grades.includes('preschool')) colorClass = "bg-[#ff91aa]";
                            else if (evt.grades.includes('grade1_2')) colorClass = "bg-[#ffac2d]";
                            else if (evt.grades.includes('grade3_plus')) colorClass = "bg-[#00b4dc]";
                        }
                        
                        item.className = `dashboard-event-item ${colorClass}`;
                        item.innerHTML = `
                            <div class="font-bold">${evt.startTime}</div>
                            <div class="truncate">${content.name}</div>
                            <div class="flex justify-between items-center mt-1">
                                <span class="font-bold">予約:${count}/${evt.capacity}</span>
                                <span class="text-xs bg-white px-1 rounded text-slate-600 font-bold">残:${remaining}</span>
                            </div>
                        `;
                        // Click logic omitted for brevity in dashboard view
                        cell.appendChild(item);
                    });
                }
                grid.appendChild(cell);
            }
        }

        // 復元箇所：予約管理リスト
        function renderBookingManagement() {
            const tbody = document.getElementById('bookingListTableBody');
            tbody.innerHTML = '';
            const sortedBookings = [...allBookings].sort((a, b) => b.date.localeCompare(a.date));

            if (sortedBookings.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">予約はありません</td></tr>`;
                return;
            }

            sortedBookings.forEach(b => {
                const content = (currentSettings.contents || []).find(c => c.id === b.contentId);
                const typeLabel = content ? (content.type === 'event' ? 'イベント' : '体験会') : '-';
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50";
                row.innerHTML = `
                    <td class="px-4 py-3 font-bold text-slate-700">${b.date}</td>
                    <td class="px-4 py-3">${b.startTime}</td>
                    <td class="px-4 py-3 font-medium">${b.courseName}</td>
                    <td class="px-4 py-3">
                        <div class="font-bold">${b.childName} <span class="text-xs font-normal">さん</span></div>
                        <div class="text-xs text-slate-500">保護者: ${b.parentName}</div>
                    </td>
                    <td class="px-4 py-3 text-center">${typeLabel}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Helper for Schedule Modal
        function openScheduleModal(dateStr) {
            selectedScheduleDateStr = dateStr;
            document.getElementById('modalDateDisplay').textContent = dateStr;
            const sel = document.getElementById('modalContentSelect');
            sel.innerHTML = '';
            (currentSettings.contents||[]).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = `${c.name} (¥${c.price})`;
                sel.appendChild(opt);
            });
            // Reset form
            document.getElementById('editingScheduleIndex').value = -1;
            document.getElementById('modalStartTime').value = '';
            document.getElementById('modalEndTime').value = '';
            document.getElementById('modalCapacity').value = 5;
            document.querySelectorAll('.schedule-grade-check').forEach(c=>c.checked=false);
            document.getElementById('addScheduleBtn').textContent = "保存";
            document.getElementById('deleteScheduleBtn').classList.add('hidden');
            
            renderScheduleTimeline();
            renderDayScheduleList();
            document.getElementById('scheduleModal').classList.remove('hidden');
        }

        // 復元箇所：スケジュール登録モーダル内のリスト表示
        function renderDayScheduleList() {
            const list = document.getElementById('dayScheduleList');
            list.innerHTML = '';
            const schedules = currentSettings.schedule[selectedScheduleDateStr] || [];
            
            schedules.forEach((item, idx) => {
                const content = (currentSettings.contents || []).find(c => c.id === item.contentId) || { name: '削除済み' };
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-200 mb-2";
                div.innerHTML = `
                    <div class="cursor-pointer flex-1" onclick="window.editSchedule(${idx})">
                        <div class="font-bold text-slate-700 hover:text-blue-600 transition">${item.startTime} - ${item.endTime || ''} ${content.name}</div>
                        <div class="text-xs text-slate-500">定員: ${item.capacity}名 <span class="text-blue-400 text-[10px] ml-1">(クリックで編集)</span></div>
                    </div>
                    <div class="flex gap-1">
                        <button class="text-blue-500 hover:bg-blue-50 p-1 rounded text-xs copy-sched-btn" data-idx="${idx}" title="複製"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg></button>
                        <button class="text-red-500 hover:bg-red-50 p-1 rounded text-xs delete-sched-btn" data-idx="${idx}" title="削除"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Add copy listeners using event delegation on container in future optimization, but explicit binding here for simplicity given the small list.
            list.querySelectorAll('.copy-sched-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.idx);
                    scheduleToCopy = schedules[idx];
                    document.getElementById('copyDialog').classList.remove('hidden');
                });
            });

            // Add delete listeners
            list.querySelectorAll('.delete-sched-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.idx);
                    if(confirm('削除しますか？')) {
                        currentSettings.schedule[selectedScheduleDateStr].splice(idx, 1);
                        await saveSettingsToFirestore(currentSettings);
                        renderDayScheduleList();
                        renderScheduleTimeline();
                        renderScheduleCalendar();
                    }
                });
            });
            
            window.editSchedule = (idx) => {
                const item = schedules[idx];
                document.getElementById('editingScheduleIndex').value = idx;
                document.getElementById('modalContentSelect').value = item.contentId;
                document.getElementById('modalStartTime').value = item.startTime;
                document.getElementById('modalEndTime').value = item.endTime || '';
                document.getElementById('modalCapacity').value = item.capacity;
                document.querySelectorAll('.schedule-grade-check').forEach(c => {
                    c.checked = item.grades && item.grades.includes(c.value);
                });
                document.getElementById('addScheduleBtn').textContent = "更新";
                document.getElementById('deleteScheduleBtn').classList.remove('hidden');
                document.getElementById('cancelScheduleEditBtn').classList.remove('hidden');
            };
        }

        // 復元箇所：スケジュール登録モーダル内のタイムライン
        function renderScheduleTimeline() {
            const timelineEl = document.getElementById('scheduleTimeline');
            timelineEl.innerHTML = '';
            const axisEl = document.getElementById('timelineAxis');
            axisEl.innerHTML = '';
            
            const startHour = 9;
            const endHour = 20;
            const pixelsPerMinute = 660 / ((endHour - startHour) * 60);

            // Draw Grid & Axis
            for (let h = startHour; h <= endHour; h++) {
                const hourTop = (h - startHour) * 60 * pixelsPerMinute;
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'absolute w-full text-center transform -translate-y-1/2';
                labelDiv.style.top = `${hourTop}px`;
                labelDiv.textContent = `${h}:00`;
                axisEl.appendChild(labelDiv);

                if (h < endHour) {
                    const hourLine = document.createElement('div');
                    hourLine.className = 'absolute w-full border-t border-slate-300 pointer-events-none';
                    hourLine.style.top = `${hourTop}px`;
                    timelineEl.appendChild(hourLine);
                    
                    for (let m = 10; m < 60; m += 10) {
                        const minTop = hourTop + (m * pixelsPerMinute);
                        const minLine = document.createElement('div');
                        minLine.className = 'absolute w-full border-t border-slate-100 pointer-events-none';
                        minLine.style.top = `${minTop}px`;
                        timelineEl.appendChild(minLine);
                    }
                }
            }

            const schedules = currentSettings.schedule[selectedScheduleDateStr] || [];
            
            schedules.forEach((item, idx) => {
                if (!item.startTime) return;
                const content = (currentSettings.contents || []).find(c => c.id === item.contentId) || { name: 'Unknown' };
                
                const startParts = item.startTime.split(':');
                const startMins = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
                let endMins = startMins + 60;
                if (item.endTime) {
                    const endParts = item.endTime.split(':');
                    endMins = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
                }
                
                const baseMins = startHour * 60;
                if (startMins < baseMins) return;

                const top = (startMins - baseMins) * pixelsPerMinute;
                const height = (endMins - startMins) * pixelsPerMinute;
                
                const block = document.createElement('div');
                let colorClass = "bg-blue-500"; 
                if (item.grades && item.grades.length > 0) {
                    if (item.grades.includes('preschool')) colorClass = "bg-[#ff91aa]";
                    else if (item.grades.includes('grade1_2')) colorClass = "bg-[#ffac2d]";
                    else if (item.grades.includes('grade3_plus')) colorClass = "bg-[#00b4dc]";
                }
                
                block.className = `timeline-event-block ${colorClass}`;
                block.style.top = `${top}px`;
                block.style.height = `${Math.max(20, height)}px`;
                block.style.left = '4px';
                block.style.right = '4px';
                block.textContent = `${item.startTime} ${content.name}`;
                block.title = `${item.startTime}-${item.endTime} ${content.name}`;
                block.draggable = true;
                
                block.addEventListener('dragstart', (e) => {
                    e.stopPropagation();
                    draggingItemIndex = idx;
                    const rect = block.getBoundingClientRect();
                    dragStartY = e.clientY - rect.top;
                    block.classList.add('dragging');
                });
                
                block.addEventListener('dragend', () => {
                    block.classList.remove('dragging');
                    draggingItemIndex = null;
                });
                
                block.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.editSchedule(idx);
                });
                
                timelineEl.appendChild(block);
            });
        }

        // Copy Dialog Logic
        document.getElementById('cancelCopyBtn').addEventListener('click', () => document.getElementById('copyDialog').classList.add('hidden'));
        
        document.getElementById('execCopyBtn').addEventListener('click', async () => {
            const targetDate = document.getElementById('copyTargetDate').value;
            if (targetDate && scheduleToCopy) {
                if (!currentSettings.schedule[targetDate]) {
                    currentSettings.schedule[targetDate] = [];
                }
                const newItem = { ...scheduleToCopy, id: 's' + Date.now() };
                currentSettings.schedule[targetDate].push(newItem);
                await saveSettingsToFirestore(currentSettings);
                document.getElementById('copyDialog').classList.add('hidden');
                showToast(`${targetDate} に複製しました`);
                renderScheduleCalendar(); 
            } else {
                alert("日付を選択してください");
            }
        });

        // Timeline Click to Add
        document.querySelector('.timeline-container').addEventListener('click', (e) => {
             if (e.target.closest('.timeline-event-block')) return;

             const timelineEl = document.getElementById('scheduleTimeline');
             const containerRect = e.currentTarget.getBoundingClientRect();
             const clickYInsideContainer = (e.clientY - containerRect.top) + e.currentTarget.scrollTop;
             
             const startHour = 9;
             const endHour = 20;
             const pixelsPerMinute = 660 / ((endHour - startHour) * 60);
             
             const minsFromStart = clickYInsideContainer / pixelsPerMinute;
             const totalMins = (startHour * 60) + minsFromStart;
             const roundedMins = Math.round(totalMins / 10) * 10;
             
             const hour = Math.floor(roundedMins / 60);
             const min = roundedMins % 60;
             
             const endTotalMins = roundedMins + 60; // Default 60 min
             const endHourVal = Math.floor(endTotalMins / 60);
             const endMin = endTotalMins % 60;

             const formatTime = (h, m) => `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
             
             document.getElementById('editingScheduleIndex').value = -1;
             document.getElementById('scheduleFormTitle').textContent = "新規枠を追加";
             document.getElementById('addScheduleBtn').textContent = "保存";
             document.getElementById('deleteScheduleBtn').classList.add('hidden');
             document.getElementById('cancelScheduleEditBtn').classList.add('hidden');
             
             document.getElementById('modalStartTime').value = formatTime(hour, min);
             document.getElementById('modalEndTime').value = formatTime(endHourVal, endMin);
        });

        // Cancel Edit Logic
        document.getElementById('cancelScheduleEditBtn').addEventListener('click', () => {
             document.getElementById('editingScheduleIndex').value = -1;
             document.getElementById('scheduleFormTitle').textContent = "新規枠を追加";
             document.getElementById('addScheduleBtn').textContent = "保存";
             document.getElementById('modalStartTime').value = "";
             document.getElementById('modalEndTime').value = "";
             document.getElementById('modalCapacity').value = 5;
             document.querySelectorAll('.schedule-grade-check').forEach(c=>c.checked=false);
             document.getElementById('deleteScheduleBtn').classList.add('hidden');
             document.getElementById('cancelScheduleEditBtn').classList.add('hidden');
        });

        // Schedule Save Logic
        document.getElementById('addScheduleBtn').addEventListener('click', async () => {
            const idx = parseInt(document.getElementById('editingScheduleIndex').value);
            const contentId = document.getElementById('modalContentSelect').value;
            const startTime = document.getElementById('modalStartTime').value;
            const endTime = document.getElementById('modalEndTime').value;
            const capacity = document.getElementById('modalCapacity').value;
            const grades = Array.from(document.querySelectorAll('.schedule-grade-check:checked')).map(c=>c.value);
            
            if(!contentId || !startTime || grades.length === 0) return alert('必須項目を入力してください');
            
            if(!currentSettings.schedule[selectedScheduleDateStr]) currentSettings.schedule[selectedScheduleDateStr] = [];
            
            const newItem = {
                id: idx !== -1 ? currentSettings.schedule[selectedScheduleDateStr][idx].id : 's'+Date.now(),
                contentId, startTime, endTime, capacity: parseInt(capacity), grades
            };
            
            if(idx !== -1) currentSettings.schedule[selectedScheduleDateStr][idx] = newItem;
            else currentSettings.schedule[selectedScheduleDateStr].push(newItem);
            
            await saveSettingsToFirestore(currentSettings);
            renderDayScheduleList();
            renderScheduleTimeline(); // Update main calendar
            renderScheduleCalendar();
            // Reset form
            document.getElementById('cancelScheduleEditBtn').click();
        });

        document.getElementById('deleteScheduleBtn').addEventListener('click', async () => {
            const idx = parseInt(document.getElementById('editingScheduleIndex').value);
            if(confirm('この枠を削除しますか？')) {
                currentSettings.schedule[selectedScheduleDateStr].splice(idx, 1);
                await saveSettingsToFirestore(currentSettings);
                renderDayScheduleList();
                renderScheduleTimeline();
                renderScheduleCalendar();
                document.getElementById('cancelScheduleEditBtn').click();
            }
        });
        
        // ★修正箇所: モーダルを閉じるイベントリスナーを追加
        document.getElementById('closeScheduleModal').addEventListener('click', () => {
            document.getElementById('scheduleModal').classList.add('hidden');
        });

        // Admin Calendar Navigation
        document.getElementById('prevScheduleMonth').onclick = () => { adminScheduleDate.setMonth(adminScheduleDate.getMonth()-1); renderScheduleCalendar(); };
        document.getElementById('nextScheduleMonth').onclick = () => { adminScheduleDate.setMonth(adminScheduleDate.getMonth()+1); renderScheduleCalendar(); };
        document.getElementById('prevDashboardMonth').onclick = () => { adminDashboardDate.setMonth(adminDashboardDate.getMonth()-1); renderAdminDashboard(); };
        document.getElementById('nextDashboardMonth').onclick = () => { adminDashboardDate.setMonth(adminDashboardDate.getMonth()+1); renderAdminDashboard(); };

        // --- Other logic from previous version (User View, Calendar, Schedule, Booking) ---
        // Reuse logic but ensure they use `currentSettings` and `currentSchoolId`
        // Simplified for brevity in this response, assuming `currentSettings` is correctly populated by `loadSchoolData`.
        
        function renderUserView() {
            if (!currentSettings) return;
            const s = currentSettings;
            nav.title.textContent = `${s.schoolName}校 予約`;
            document.getElementById('headerSchoolName').textContent = s.schoolName;
            document.getElementById('pageTitleDisplay').textContent = s.pageTitle;
            document.getElementById('pageDescriptionDisplay').textContent = s.pageDescription;
            document.getElementById('headerImage').src = s.headerImageUrl;
            document.getElementById('schoolInfoDisplay').innerHTML = `<span class="font-bold">${s.schoolName}校</span> | ${s.address} | ${s.phoneNumber}`;
            resetBookingView();
        }

        // ... (Calendar, TimeSlots, Schedule Modal logic same as before, referring to `currentSettings.schedule`) ...
        // Re-implement key parts for functionality:

        function resetBookingView() {
            gradeSelector.querySelectorAll('button').forEach(btn => {
                const conf = GRADE_CONFIG[btn.dataset.grade];
                btn.className = `grade-btn w-full text-lg font-bold py-4 px-4 bg-white border-2 ${conf.btnBorder} ${conf.btnText} rounded-xl ${conf.btnHover} transition-transform hover:scale-105`;
            });
            document.getElementById('calendarContainer').style.display = 'none';
            document.getElementById('timeSlotsContainer').style.display = 'none';
            document.getElementById('bookingForm').style.display = 'none';
            selectedGrade = null;
        }

        gradeSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                selectedGrade = e.target.dataset.grade;
                const conf = GRADE_CONFIG[selectedGrade];
                gradeSelector.querySelectorAll('button').forEach(btn => {
                    const c = GRADE_CONFIG[btn.dataset.grade];
                    btn.className = `grade-btn w-full text-lg font-bold py-4 px-4 bg-white border-2 ${c.btnBorder} ${c.btnText} rounded-xl ${c.btnHover} transition-transform hover:scale-105`;
                });
                e.target.className = `grade-btn w-full text-lg font-bold py-4 px-4 border-2 ${conf.bg} ${conf.text} ${conf.btnBorder} rounded-xl shadow-lg transform scale-105`;
                document.getElementById('calendarContainer').style.display = 'block';
                renderUserCalendar();
            }
        });

        // Calendar
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarTitle = document.getElementById('calendarTitle');
        let viewDate = new Date(); viewDate.setDate(1);
        document.getElementById('prevMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth()-1); renderUserCalendar(); };
        document.getElementById('nextMonth').onclick = () => { viewDate.setMonth(viewDate.getMonth()+1); renderUserCalendar(); };

        function renderUserCalendar() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            calendarTitle.textContent = `${year}年 ${month + 1}月`;
            calendarGrid.querySelectorAll('.calendar-day').forEach(d => d.remove());
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date(); today.setHours(0,0,0,0);

            for(let i=0; i<firstDay; i++) calendarGrid.appendChild(document.createElement('div'));

            for(let d=1; d<=daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.textContent = d;
                cell.className = 'calendar-day flex items-center justify-center rounded-full transition';
                const dateObj = new Date(year, month, d);
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                let isAvailable = false;
                if(currentSettings.schedule && currentSettings.schedule[dateStr]) {
                    isAvailable = currentSettings.schedule[dateStr].some(evt => {
                        const content = currentSettings.contents.find(c => c.id === evt.contentId);
                        const targetGrades = evt.grades || (content ? content.grades : []) || [];
                        return targetGrades.includes(selectedGrade);
                    });
                }

                if (dateObj < today) { cell.classList.add('disabled', 'text-slate-300'); } 
                else if (isAvailable) {
                    cell.classList.add('available');
                    const conf = GRADE_CONFIG[selectedGrade];
                    cell.setAttribute('style', `color: ${conf.bg.replace('bg-[','').replace(']','')}; background-color: #f0fdfa; font-weight: bold;`);
                    cell.onclick = () => {
                        selectedDate = dateObj;
                        document.querySelectorAll('.calendar-day').forEach(c => c.classList.remove('selected-day'));
                        cell.classList.add('selected-day');
                        cell.setAttribute('style', ''); 
                        renderTimeSlots(selectedDate);
                    };
                } else { cell.classList.add('disabled', 'text-slate-300'); }
                calendarGrid.appendChild(cell);
            }
        }

        function renderTimeSlots(date) {
            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '';
            container.style.display = 'block';
            const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
            const list = document.createElement('div');
            list.className = "flex flex-col gap-3 max-w-sm mx-auto";
            
            const events = (currentSettings.schedule[dateStr] || []).filter(evt => {
                const content = currentSettings.contents.find(c => c.id === evt.contentId);
                const targetGrades = evt.grades || (content ? content.grades : []) || [];
                return targetGrades.includes(selectedGrade);
            }).sort((a,b) => a.startTime.localeCompare(b.startTime));

            if(events.length === 0) list.innerHTML = `<p class="text-center text-slate-400">空き枠がありません</p>`;
            else {
                events.forEach(evt => {
                    const content = currentSettings.contents.find(c => c.id === evt.contentId);
                    const booked = allBookings.filter(b => b.date === dateStr && b.startTime === evt.startTime && b.contentId === evt.contentId).length;
                    const remaining = evt.capacity - booked;
                    const conf = GRADE_CONFIG[selectedGrade];
                    const btn = document.createElement('button');
                    
                    if(remaining <= 0) {
                        btn.className = "p-4 rounded-xl bg-slate-100 text-slate-400 cursor-not-allowed border";
                        btn.textContent = `${evt.startTime} ${content.name} (満席)`;
                        btn.disabled = true;
                    } else {
                        btn.className = `p-4 rounded-xl border-2 ${conf.btnBorder} ${conf.btnText} bg-white hover:brightness-95 transition text-left shadow-sm`;
                        btn.innerHTML = `<span class="font-bold text-lg">${evt.startTime}</span> <span class="text-sm">${content.name}</span> <span class="float-right text-xs bg-slate-100 px-2 py-1 rounded">残${remaining}</span>`;
                        btn.onclick = () => {
                            selectedContent = content; selectedStartTime = evt.startTime; selectedSlotCapacity = evt.capacity;
                            document.getElementById('bookingForm').style.display = 'block';
                            document.getElementById('bookingForm').scrollIntoView({behavior:'smooth'});
                            document.getElementById('confirmSchoolName').textContent = currentSettings.schoolName;
                            document.getElementById('selectedSlotInfo').textContent = `${date.getMonth()+1}/${date.getDate()} ${evt.startTime} ${content.name}`;
                            document.getElementById('selectedPriceInfo').textContent = `¥${content.price}`;
                            document.getElementById('inputPhase').classList.remove('hidden');
                            document.getElementById('confirmPhase').classList.add('hidden');
                        };
                    }
                    list.appendChild(btn);
                });
            }
            container.appendChild(list);
        }

        // Booking Process
        document.getElementById('userInfoForm').onsubmit = (e) => {
            e.preventDefault();
            pendingBookingData = {
                schoolId: currentSchoolId,
                schoolName: currentSettings.schoolName,
                date: selectedDate.toISOString().split('T')[0],
                startTime: selectedStartTime,
                contentId: selectedContent.id,
                courseName: selectedContent.name,
                parentName: document.getElementById('parentName').value,
                childName: document.getElementById('childName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                grade: selectedGrade
            };
            document.getElementById('confirmParentName').textContent = pendingBookingData.parentName;
            document.getElementById('confirmEmail').textContent = pendingBookingData.email;
            document.getElementById('confirmPhone').textContent = pendingBookingData.phone;
            document.getElementById('confirmChildName').textContent = pendingBookingData.childName;
            document.getElementById('inputPhase').classList.add('hidden');
            document.getElementById('confirmPhase').classList.remove('hidden');
        };

        document.getElementById('confirmBookingBtn').onclick = async () => {
            const btn = document.getElementById('confirmBookingBtn');
            btn.disabled = true;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), { ...pendingBookingData, createdAt: serverTimestamp() });
            document.getElementById('successModal').classList.remove('hidden');
            btn.disabled = false;
        };

        document.getElementById('closeModal').onclick = () => {
            document.getElementById('successModal').classList.add('hidden');
            resetBookingView();
            document.getElementById('userInfoForm').reset();
            window.scrollTo({top:0, behavior:'smooth'});
        };

        // Admin Dashboard, Schedule, Bookings render logic would follow similar patterns using `currentSettings` and `allBookings`
        // Omitting full re-implementation for brevity, but critical parts for "Add from Master" are included above.
        // Specifically, schedule modal logic needs to populate `modalContentSelect`
        
        // Helper for Schedule Modal Select
        function updateScheduleModalSelect() {
            const sel = document.getElementById('modalContentSelect');
            sel.innerHTML = '';
            (currentSettings.contents||[]).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.name;
                sel.appendChild(opt);
            });
        }
        // Hook this into openScheduleModal logic in full implementation

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab', 'border-blue-500', 'text-blue-600'));
                btn.classList.add('active-tab', 'border-blue-500', 'text-blue-600');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
                document.getElementById('saveBtnContainer').classList.toggle('hidden', btn.dataset.tab !== 'school-settings');
            };
        });

        initFirebase();
    });
    </script>
</body>
</html>
